package main

import (
	"code.google.com/p/portaudio-go/portaudio"
	"fmt"
	"github.com/edmccard/avr-sim/core"
	"github.com/edmccard/avr-sim/instr"
	"strings"
	"time"
)

func main() {
	portaudio.Initialize()
	defer portaudio.Terminate()

	cpu := core.Cpu{}
	mem := NewDemoMem(&cpu, strings.NewReader(program))
	decoder := instr.NewDecoder(instr.NewSetEnhanced8k())
	timer := &core.Timer{}

	ticker := time.NewTicker(20 * time.Millisecond)
	quit := make(chan struct{})

	spk, err := NewSpeaker(timer, 1020500)
	if err != nil {
		fmt.Println("ERROR:", err)
		return
	}
	mem.outports[0x38] = spk.write

	go func() {
		cycles := uint(0)
		elapsed := uint(0)
		started := false

		for {
			select {
			case <-ticker.C:
				for cycles < 20410 {
					elapsed = cpu.Step(mem, &decoder)
					cycles += elapsed
					timer.Tick(int64(elapsed))
				}
				cycles -= 20410
				if !started {
					err = spk.Start()
					if err != nil {
						fmt.Println("ERROR:", err)
						return
					}
					started = true
				}
			case <-quit:
				ticker.Stop()
				spk.Stop()
				return
			}
		}
	}()

	time.Sleep(142 * time.Second)
	close(quit)
}

const program = `
:020000020000FC
:100000001FE51DBF14E01EBF10E01F9310E01F93FB
:100010001FEF1F931FEB1F9317EB1F93EAEAF3E009
:1000200010E41093000110E01093010113E010930D
:10003000020114E01093030110E0112E18E0512E7C
:1000400019E0612E19E0712E19E0812E16E0912E33
:1000500010E8A12E18E0B12E10E0C12E10E0D12E34
:1000600010E0E12E11E4F12E11E4012F10E4212F14
:1000700010E8312F1FEF412F11E0512F10E0612FB9
:1000800010E4712F10E0A12F1FE3C12FA89437FBBC
:100090009894089411E017BBAFC0000000C01F93F4
:1000A0001F9130920201409203011E2FC895319694
:1000B000202CC8953196302CC8953196402CE117EC
:1000C00018F400001F931F9100001F931F915A9472
:1000D00012F000001DC01F931F911F931F9109E094
:1000E000502E6A949AF4000000C01F931F91602E56
:1000F0007A9452F4000000C01F931F91702E8A94CE
:100100000AF4802E10E14AD110E148D110E146D125
:100110001FEF44D1000000C014EE40D11F931F9187
:100120001F931F91022D013019F0000018F439C1FE
:100130000000B3CF00001F931F91902E90D01F930B
:100140001F91AA2EA0910201000000C00695AA9559
:10015000D9F700C01F931F91B02EB3D01F931F91EA
:10016000CA2EA0910301000000C00695AA95D9F7F8
:1001700000001F931F911F931F911F931F91D02E5B
:10018000CF91AF910F91003021F4000011E0E126F2
:10019000E8BA00C000301AF0000000C004C000003F
:1001A00011E0E126E8BA00C01F931F911F931F9131
:1001B000F02ECA9511F4000005C000C0CB1529F03F
:1001C000000005C00000C0910001A7FC0227A89410
:1001D000F6FC42F417FAF7FC62F4000000C01F932B
:1001E0001F9172F437FBF7FE2AF400C01F931F9192
:1001F0003AF40000000000C0000011E0E126E8BA77
:1002000000001F931F914A95B1F400001F931F91A6
:100210005A9519F4000000C079D000001F931F9177
:100220009A9449F426F400C011E0E126E8BA0F934D
:10023000AF93CF933ACF00C0AA9511F4000005C048
:1002400000C0AD1529F0000005C00000A09101011B
:10025000C7FC03270EF499CF000000C09ACF00001E
:1002600000C01F931F911F931F9100C01F931F91E8
:100270001F931F91032D00930001003021F01F9365
:100280001F91000FE0F71F931F911EE587D000001C
:100290000CC01F931F91003021F01F931F91000F7E
:1002A000E0F71F931F911EE579D0000000C01F9357
:1002B0001F91A0E8032D003011F40000A0E000C061
:1002C000089500001F931F911F931F9100C01F935B
:1002D0001F911F931F91042D009301011F931F91E4
:1002E000003021F01F931F91000FE0F71F931F9123
:1002F0001EE554D0000000C01F931F91A0E8042DFC
:10030000003011F40000A0E000C008951F931F9179
:100310001F931F910F93AF93CF93C8E1633741F4BD
:10032000733439F400C060E070E400001DE036D0A2
:1003300000C000C000001BE031D000C0CA9572F7B9
:1003400000C01F931F911F931F9100C01F931F9107
:100350001F931F9100C01F931F911F931F916395BF
:1003600081F400C01F931F911F931F9100C01F9322
:100370001F911F931F9100001F931F911F931F91A7
:10038000739500C01F931F9100C01F931F911F936F
:100390001F9158E0CF91AF910F9108951A95F1F701
:1003A0000895FFCF01030406400006400006400008
:1003B000068000063600066C000640000640000677
:1003C00080000640000630000660000640000680FF
:1003D0000006480006900006400006FF00062B00BD
:1003E00006AC0006400006480006900006400006E5
:1003F000FF0006400006280006A000062B0006AC01
:100400000006360006D80006400006FF00062B0056
:1004100006AC0006200006800006400006480006E4
:10042000900006560006560006AC0006390006E4A9
:10043000003040FE4000000104040640FE0640FE7D
:100440000640FE0680FE0636FE066CFE0640FE06F0
:1004500040FE0680FE0640FE0630FE0660FE0640B8
:10046000FE0680FE0648FE0690FE0640D706D8D758
:10047000062BD706D8D70640D70648D706D8D706C2
:1004800040D706D8D70640D70628D706D8D7062B98
:10049000D706D8D70636D706D8D70640C106C0C17A
:1004A000062BC106C0C10620C10680C10640C10698
:1004B00048C106C0C10656C10656C106C0C10639AC
:1004C000C106C0C10640FE06FFFE0680FE06FFFE16
:1004D00006FFFE0680FE06FFFE06FFFE0680FE0605
:1004E000FFFE0640FE0680FE0636FE066CFE064057
:1004F000FE06FFFE0640FE06FFFE0680FE06FFFE2D
:100500000636FE06FFFE0680FE0640FE06FFFE06DD
:1005100040FE0630FE06FFFE0640FE06FFFE0648D1
:10052000FE06FFFE0640D70690D70648D70690D7AE
:10053000062BD70648D70690D70640D70690D70691
:1005400040D70628D70690D7062BD70690D7063671
:10055000D70690D70640C106C0C1062BC106C0C150
:100560000620C10660C10640C10648D706D8D70696
:1005700056D70656D706D8D70639D706D8D7064055
:10058000FE06FFFE0680FE0680FE06FFFE0680FEDB
:1005900006FFFE0680FE0680FE06FFFE010304063F
:1005A00040FE0680FE0636FE06FFFE0640FE068082
:1005B000FE0640D706D8D7066CD706D8D706D8D7B8
:1005C000066CD706D8D706D8D7066CD706D8D70674
:1005D00040D706D8D70636D70640D7066CD706D8F8
:1005E000D70640C10660C10660C106C0C10660C131
:1005F00006C0C10660C10660C106C0C10640C10692
:1006000040C10660C10636C10660C10640C106C0D1
:10061000C10640A10650A10636A106A0A10640A130
:1006200006A0A10648A10640C106C0C10636C10603
:1006300060C106C0C10640C10648C106C0C106600F
:10064000C10640FE06FFFE0680FE06FFFE06FFFE18
:100650000680FE06FFFE06FFFE0680FE06FFFE0683
:1006600040FE0680FE0636FE0640FE06FFFE0680C1
:10067000FE0104030640D706D8D7066CD706D8D7A4
:10068000066CD706D8D7066CD7066CD706D8D7061F
:10069000D8D70640D7066CD70636D70640D7066CA3
:1006A000D706D8D70640C10660C10660C106C0C1E2
:1006B0000660C106C0C10660C10660C106C0C106B1
:1006C00040C10640C10660C10636C10660C1064091
:1006D000C106C0C10640A10650A10636A106A0A1D0
:1006E0000640A106A0A10648A106409106909106E9
:1006F000369106609106409106489106C0910640E9
:10070000FE06FFFE0680FE06FFFE06FFFE0680FEDA
:1007100006FFFE06FFFE0680FE06FFFE0640FE0602
:1007200080FE0636FE0640FE0680FE06FFFE010243
:10073000030640FE06FFFE0680FE06FFFE0636FEAE
:100740000680FE06FFFE0640FE0680FE0640FE0610
:1007500030FE0680FE0640FE06FFFE0648FE06FF4F
:10076000FE0640D706D8D7066CD706D8D7062BD7B3
:10077000066CD706D8D70640D7066CD70640D706F2
:1007800028D7066CD7062BD706D8D70636D706D873
:10079000D70640C10660C1062BC106C0C10620C1F4
:1007A00006C0C10640C10648C106C0C10656C10602
:1007B00056C106C0C10639C106C0C10640FE06FFCB
:1007C000FE06FFFE0680FE06FFFE06FFFE0680FE1A
:1007D00006FFFE0680FE0640FE0640FE0680FE0680
:1007E00036FE06FFFE0640FE06FFFE01030206403F
:1007F000FE06FFFE0680FE06FFFE0636FE06FFFE34
:100800000680FE0640FE0680FE0640FE0630FE061E
:10081000FFFE0640FE06FFFE0648FE06FFFE0640FF
:10082000D706D8D7066CD706D8D7062BD706D8D781
:10083000066CD70640D706D8D70640D70628D70675
:10084000D8D7062BD706D8D70636D706D8D706402E
:10085000C106C0C1062BC106C0C10620C10660C1C9
:100860000640C10648D706D8D70656D70656D7063B
:10087000D8D70639D706D8D70640FE06FFFE068031
:10088000FE06FFFE0680FE06FFFE0680FE0680FED8
:1008900006FFFE0680FE06FFFE06FFFE0680FE0641
:1008A000FFFE0680FE06FFFE0102020640A106A032
:1008B000A10650A106A0A10636A106A0A10650A13E
:1008C0000640A106A0A10640A10630A10650A1063F
:1008D00040A10650A10648A106A0A10640C106609D
:1008E000C1062BC10660C10640C10648C106C0C191
:1008F0000640C10660C10640C10628C10660C106A7
:100900002BC106C0C10636C10660C10640AB06ACAD
:10091000AB062BAB0656AB0620AB0656AB0640AB80
:1009200006489106909106569106569106909106BA
:1009300039910690910640FE06FFFE0680FE06FFF6
:10094000FE06FFFE0680FE06FFFE06FFFE0680FE98
:1009500006FFFE06FFFE0680FE06FFFE06FFFE0601
:1009600080FE06FFFE066CD706D8D706D8D7066CE1
:10097000D706D8D706D8D7066CD706D8D70678D7E3
:1009800006D8D70672D7066CD706D8D706D8D706AA
:10099000D8D706D8D7066CD706D8D706D8D7066CCE
:1009A000D706D8D706D8D7066CD706D8D70648D7E3
:1009B00006D8D70650D706D8D7065AD70656D70630
:1009C0006CD7066CD70103040636D706D8D7066C59
:1009D000D706D8D70636D7066CD706D8D70636D767
:1009E00006D8D7063CD7066CD70639D70636D706C1
:1009F0006CD706D8D7066CD706D8D70636D706D810
:100A0000D7066CD70636D7066CD706D8D70636D7A2
:100A100006D8D70624D7066CD70628D706D8D70617
:100A20002DD7062BD70636D70636F106F0F1067815
:100A3000F106F0F10636F10678F106F0F10636F12E
:100A40000678F1063CF106F0F10639F10636F106BA
:100A5000F0F106F0F10678F106F0F10636F106F055
:100A6000F10678F10636F106F0F10678F10636F176
:100A700006F0F10624F106F0F10628F106F0F10681
:100A80002DF1062BF10636F10636F10650A106A02F
:100A9000A10650A10636A106A0A10650A10636A1C6
:100AA00006A0A1063CA10650A10639A10636A10662
:100AB00050A106A0A106A0A10650A10636A106508D
:100AC000A106A0A10636A106A0A10650A10636A146
:100AD00006A0A10624A106A0A10628A10650A106F1
:100AE0002DA1062BA10636A10103030636D706D891
:100AF000D7066CD706D8D70636D7066CD706D8D710
:100B00000636D706D8D7063CD7066CD70639D7069F
:100B100036D7066CD706D8D7066CD706D8D7063690
:100B2000D706D8D7066CD70636D7066CD706D8D7DF
:100B30000636D706D8D70624D7066CD70628D70698
:100B4000D8D7062DD7062BD70636D701030206368F
:100B5000D706D8D7066CD706D8D70636D7066CD7AF
:100B600006D8D70636D706D8D7063CD7066CD706A0
:100B700039D70636D7066CD706D8D7066CD706D82D
:100B8000D70636D706D8D7066CD70636D7066CD721
:100B900006D8D70636D706D8D70624D7066CD70688
:100BA00028D706D8D7062DD7062BD70636D7063630
:100BB000F106F0F10678F106F0F10636F106F0F1F3
:100BC0000678F10636F10678F1063CF106F0F106FA
:100BD00039F10636F106F0F10678F106F0F1067803
:100BE000F10636F106F0F10678F10636F106F0F17D
:100BF0000678F10636F106F0F10624F106F0F1066A
:100C000028F106F0F1062DF1062BF10636F1063635
:100C1000F10650A106A0A10650A10636A106A0A18A
:100C20000650A10636A106A0A1063CA10650A106C9
:100C300039A10636A10650A106A0A106A0A1065022
:100C4000A10636A10650A106A0A10636A106A0A1C4
:100C50000650A10636A106A0A1063CA106A0A10649
:100C600036A1062DA10650A10636A1062DA106A08B
:100C7000A10103040636D70636D70636D7066CD749
:100C8000062DD7066CD70636D70636D7066CD7069C
:100C900036D70628D7066CD70636D7066CD7063C5B
:100CA000D706D8D70636F10678F10624F10678F192
:100CB0000636F1063CF106F0F10636F10678F1064B
:100CC00036F10622F106F0F10624F10678F1062D40
:100CD000F10678F10636A10650A10624A106A0A1CE
:100CE000061BA10650A10636A1063CB506B4B50602
:100CF00048B50648B506B4B50630B5065AB5063649
:100D0000D706D8D7066CD706D8D706D8D7066CD75B
:100D100006D8D706D8D7066CD706D8D70636D70652
:100D20006CD7062DD706D8D70636D706D8D70103F5
:100D3000040636D706D8D7066CD706D8D7062DD7DF
:100D4000066CD706D8D70636D7066CD70636D70630
:100D500028D7066CD70636D7066CD7063CD706D8F8
:100D6000D70636F10678F10624F10678F10636F159
:100D7000063CF106F0F10636F10678F10636F1068A
:100D800022F106F0F10624F10678F1062DF106783D
:100D9000F10636A10650A10624A106A0A1061BA1BA
:100DA0000650A10636A1063CB506B4B50648B50600
:100DB00048B506B4B50630B5065AB50636D706D8D6
:100DC000D7066CD706D8D706D8D7066CD706D8D79B
:100DD00006D8D7066CD706D8D70636D7066CD706FE
:100DE0002DD706D8D70636D706D8D70636A106504F
:100DF000A106A0A106A0A10650A106A0A106A0A13F
:100E00000650A106000006000006000006000006CD
:100E1000000006000006000006A0A10650A106A0E2
:100E2000A106A0A10650A106A0A106A0A10650A15E
:100E3000060000060000060000060000060000068E
:100E4000000006000006B4B5065AB506B4B506B4EF
:100E5000B5065AB506B4B506B4B5065AB506B4B566
:100E600006B4B5065AB506B4B5065AB506B4B50605
:100E70005AB506B4B506D8D7066CD706D8D706D863
:100E8000D7066CD706D8D706D8D7066CD706D8D7DA
:100E900006D8D70636D706D8D7062DD7066CD7067C
:100EA00036D706D8D70636D706D8D7066CD706D891
:100EB000D706D8D7066CD706D8D706D8D7066CD7AA
:100EC00006D8D70636D7066CD7062DD706D8D7064C
:100ED00028D7066CD70103040636A10650A106A048
:100EE000A106A0A10650A106A0A106A0A10650A19E
:100EF00006A0A106A0A10650A106A0A1065AA1061F
:100F0000A0A10650A106A0A106B4B5065AB506B424
:100F1000B506B4B5065AB506B4B506B4B5065AB5A5
:100F200006B4B506B4B5065AB506B4B50660B5063E
:100F3000B4B5065AB506B4B506D8D7066CD706D8E8
:100F4000D706D8D7066CD706D8D706D8D7066CD719
:100F500006D8D706D8D70636D706D8D7062DD7064F
:100F60006CD70636D706D8D70636D706D8D7066C3C
:100F7000D706D8D706D8D7066CD706D8D706D8D77D
:100F8000066CD706D8D70636D7066CD7062DD706F7
:100F9000D8D70636D7066CD70102020636D7060028
:100FA00000060000060000062DD70600000600001F
:100FB0000636D70600000636D70628D706000006F4
:100FC00036D7060000063CD70600000636B50600F8
:100FD000000600000600000624B50600000600001A
:100FE0000636B50600000636B50622B50600000630
:100FF00024B5060000062DB50600000636A1060041
:10100000000624A1060000061BA10600000636A16A
:10101000063CA10600A10648A10648A106A0A1061B
:101020002DA106A0A10636D706D8D7066CD706D8BC
:10103000D706D8D7066CD706D8D706D8D7066CD728
:1010400006D8D70636D7066CD7062DD706D8D706CA
:1010500036D706D8D70636D706D8D7066CD706D8DF
:10106000D7062DD7066CD706D8D70636D7066CD745
:101070000636D70628D7066CD70636D7066CD706AD
:101080003CD706D8D70636F10678F10624F1067863
:10109000F10636F1063CF106F0F10636F10678F17C
:1010A0000636F10622F106F0F10624F10678F10683
:1010B0002DF10678F10636A10650A10624A106A05E
:1010C000A1061BA10650A10636A1063CB506B4B583
:1010D0000648B50648B506B4B50630B5065AB50695
:1010E00036D706D8D7066CD706D8D706D8D7066C19
:1010F000D706D8D706D8D7066CD706D8D70636D79E
:10110000066CD7062DD706D8D70636D706D8D7010E
:1011100003030636A10650A106A0A106A0A1065011
:10112000A106A0A106A0A10650A106A0A106A0A10B
:101130000650A106A0A1065AA106A0A10650A1062C
:10114000A0A106B4B5065AB506B4B506B4B5065A9C
:10115000B506B4B506B4B5065AB506B4B506B4B509
:10116000065AB506B4B50660B506B4B5065AB50656
:10117000B4B506D8D7066CD706D8D706D8D7066C2C
:10118000D706D8D706D8D7066CD706D8D706D8D76B
:101190000636D706D8D7062DD7066CD70636D7061B
:1011A000D8D70636D706D8D7066CD706D8D706D8EC
:1011B000D7066CD706D8D706D8D7066CD706D8D7A7
:1011C0000636D7066CD7062DD70636D7066CD70657
:1011D000D8D701020140D8D700FFFF00000000006F
:0411E000000000000B
:00000001FF
`
