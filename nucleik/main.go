package main

import (
	"code.google.com/p/portaudio-go/portaudio"
	"fmt"
	"github.com/edmccard/avr-sim/core"
	"github.com/edmccard/avr-sim/instr"
	"strings"
	"time"
)

var cycleCount uint64

func main() {
	portaudio.Initialize()
	defer portaudio.Terminate()

	cpu := core.Cpu{}
	mem := NewDemoMem(&cpu, strings.NewReader(program))
	decoder := instr.NewDecoder(instr.NewSetEnhanced8k())

	ticker := time.NewTicker(20 * time.Millisecond)
	quit := make(chan struct{})

	spk, err := NewSpeaker(1020484)
	if err != nil {
		fmt.Println("ERROR:", err)
		return
	}
	mem.outports[0x38] = spk.write

	go func() {
		cycles := uint(0)
		elapsed := uint(0)
		started := false

		for {
			select {
			case <-ticker.C:
				for cycles < 20000 {
					elapsed = cpu.Step(mem, &decoder)
					cycles += elapsed
					cycleCount += uint64(elapsed)
				}
				cycles -= 20000
				if !started {
					err = spk.Start()
					if err != nil {
						fmt.Println("ERROR:", err)
						return
					}
					started = true
				}
			case <-quit:
				ticker.Stop()
				spk.Stop()
				return
			}
		}
	}()

	time.Sleep(142 * time.Second)
	close(quit)
}

const program = `
:020000020000FC
:100000001FE51DBF14E01EBF10E01F9310E01F93FB
:100010001FEF1F931FEB1F9317EB1F93E6EAF3E00D
:1000200010E41093000110E01093010113E010930D
:10003000020114E01093030110E0112E18E0512E7C
:1000400019E0612E19E0712E19E0812E16E0912E33
:1000500010E8A12E18E0B12E10E0C12E10E0D12E34
:1000600010E0E12E11E4F12E11E4012F10E4212F14
:1000700010E8312F1FEF412F11E0512F10E0612FB9
:1000800010E4712F10E0A12F1FE3C12FA89437FBBC
:1000900098940894AFC0000000C01F931F91309245
:1000A0000201409203011E2FC8953196202CC8955D
:1000B0003196302CC8953196402CE11718F4000089
:1000C0001F931F9100001F931F915A9412F000007C
:1000D0001DC01F931F911F931F9109E0502E6A941A
:1000E0009AF4000000C01F931F91602E7A9452F47E
:1000F000000000C01F931F91702E8A940AF4802E76
:1001000010E14AD110E148D110E146D11FEF44D1AE
:10011000000000C014EE40D11F931F911F931F9148
:10012000022D013019F0000018F439C10000B3CFDE
:1001300000001F931F91902E90D01F931F91AA2E05
:10014000A0910201000000C00695AA95D9F700C051
:100150001F931F91B02EB3D01F931F91CA2EA09151
:100160000301000000C00695AA95D9F700001F936F
:100170001F911F931F911F931F91D02ECF91AF916D
:100180000F91003021F4000011E0E126E8BA00C030
:1001900000301AF0000000C004C0000011E0E126A9
:1001A000E8BA00C01F931F911F931F91F02ECA95AC
:1001B00011F4000005C000C0CB1529F0000005C0F7
:1001C0000000C0910001A7FC0227A894F6FC42F4AD
:1001D00017FAF7FC62F4000000C01F931F9172F43D
:1001E00037FBF7FE2AF400C01F931F913AF400007A
:1001F000000000C0000011E0E126E8BA00001F93F3
:100200001F914A95B1F400001F931F915A9519F45C
:10021000000000C079D000001F931F919A9449F408
:1002200026F400C011E0E126E8BA0F93AF93CF9314
:100230003ACF00C0AA9511F4000005C000C0AD156A
:1002400029F0000005C00000A0910101C7FC0327B0
:100250000EF499CF000000C09ACF000000C01F9399
:100260001F911F931F9100C01F931F911F931F91F8
:10027000032D00930001003021F01F931F91000F08
:10028000E0F71F931F911EE587D000000CC01F935D
:100290001F91003021F01F931F91000FE0F71F9373
:1002A0001F911EE579D0000000C01F931F91A0E8A8
:1002B000032D003011F40000A0E000C008950000FC
:1002C0001F931F911F931F9100C01F931F911F9396
:1002D0001F91042D009301011F931F91003021F005
:1002E0001F931F91000FE0F71F931F911EE554D03D
:1002F000000000C01F931F91A0E8042D003011F4EE
:100300000000A0E000C008951F931F911F931F914C
:100310000F93AF93CF93C8E1633741F4733439F44B
:1003200000C060E070E400001DE036D000C000C0F6
:1003300000001BE031D000C0CA9572F700C01F93C7
:100340001F911F931F9100C01F931F911F931F9117
:1003500000C01F931F911F931F91639581F400C0EC
:100360001F931F911F931F9100C01F931F911F93F5
:100370001F9100001F931F911F931F91739500C041
:100380001F931F9100C01F931F911F931F9158E04F
:10039000CF91AF910F9108951A95F1F70895FFCF7E
:1003A00001030406400006400006400006800006E7
:1003B0003600066C0006400006400006800006403D
:1003C0000006300006600006400006800006480077
:1003D00006900006400006FF00062B0006AC000653
:1003E000400006480006900006400006FF00064058
:1003F0000006280006A000062B0006AC000636000A
:1004000006D80006400006FF00062B0006AC0006DA
:1004100020000680000640000648000690000656B0
:100420000006560006AC0006390006E4003040FE27
:100430004000000104040640FE0640FE0640FE06A1
:1004400080FE0636FE066CFE0640FE0640FE068076
:10045000FE0640FE0630FE0660FE0640FE0680FEFA
:100460000648FE0690FE0640D706D8D7062BD706CC
:10047000D8D70640D70648D706D8D70640D706D8DB
:10048000D70640D70628D706D8D7062BD706D8D701
:100490000636D706D8D70640C106C0C1062BC1060E
:1004A000C0C10620C10680C10640C10648C106C0C1
:1004B000C10656C10656C106C0C10639C106C0C133
:1004C0000640FE06FFFE0680FE06FFFE06FFFE0655
:1004D00080FE06FFFE06FFFE0680FE06FFFE0640CB
:1004E000FE0680FE0636FE066CFE0640FE06FFFE99
:1004F0000640FE06FFFE0680FE06FFFE0636FE06EE
:10050000FFFE0680FE0640FE06FFFE0640FE0630A9
:10051000FE06FFFE0640FE06FFFE0648FE06FFFE44
:100520000640D70690D70648D70690D7062BD706A1
:1005300048D70690D70640D70690D70640D706285A
:10054000D70690D7062BD70690D70636D70690D772
:100550000640C106C0C1062BC106C0C10620C106A7
:1005600060C10640C10648D706D8D70656D70656FA
:10057000D706D8D70639D706D8D70640FE06FFFEDD
:100580000680FE0680FE06FFFE0680FE06FFFE06D3
:1005900080FE0680FE06FFFE0103040640FE068084
:1005A000FE0636FE06FFFE0640FE0680FE0640D72B
:1005B00006D8D7066CD706D8D706D8D7066CD70684
:1005C000D8D706D8D7066CD706D8D70640D706D8CE
:1005D000D70636D70640D7066CD706D8D70640C10F
:1005E0000660C10660C106C0C10660C106C0C10682
:1005F00060C10660C106C0C10640C10640C10660B8
:10060000C10636C10660C10640C106C0C10640A190
:100610000650A10636A106A0A10640A106A0A1068B
:1006200048A10640C106C0C10636C10660C106C069
:10063000C10640C10648C106C0C10660C10640FEF1
:1006400006FFFE0680FE06FFFE06FFFE0680FE0693
:10065000FFFE06FFFE0680FE06FFFE0640FE068049
:10066000FE0636FE0640FE06FFFE0680FE0104037F
:100670000640D706D8D7066CD706D8D7066CD7065B
:10068000D8D7066CD7066CD706D8D706D8D7064079
:10069000D7066CD70636D70640D7066CD706D8D70C
:1006A0000640C10660C10660C106C0C10660C10641
:1006B000C0C10660C10660C106C0C10640C1064097
:1006C000C10660C10636C10660C10640C106C0C190
:1006D0000640A10650A10636A106A0A10640A1062B
:1006E000A0A10648A10640910690910636910660A9
:1006F0009106409106489106C0910640FE06FFFE15
:100700000680FE06FFFE06FFFE0680FE06FFFE06D2
:10071000FFFE0680FE06FFFE0640FE0680FE063651
:10072000FE0640FE0680FE06FFFE0102030640FEB6
:1007300006FFFE0680FE06FFFE0636FE0680FE066B
:10074000FFFE0640FE0680FE0640FE0630FE0680E6
:10075000FE0640FE06FFFE0648FE06FFFE0640D7E8
:1007600006D8D7066CD706D8D7062BD7066CD7067F
:10077000D8D70640D7066CD70640D70628D7066CD0
:10078000D7062BD706D8D70636D706D8D70640C106
:100790000660C1062BC106C0C10620C106C0C10645
:1007A00040C10648C106C0C10656C10656C106C0B2
:1007B000C10639C106C0C10640FE06FFFE06FFFEA7
:1007C0000680FE06FFFE06FFFE0680FE06FFFE0612
:1007D00080FE0640FE0640FE0680FE0636FE06FF50
:1007E000FE0640FE06FFFE0103020640FE06FFFE77
:1007F0000680FE06FFFE0636FE06FFFE0680FE06AB
:1008000040FE0680FE0640FE0630FE06FFFE064065
:10081000FE06FFFE0648FE06FFFE0640D706D8D7B6
:10082000066CD706D8D7062BD706D8D7066CD706BE
:1008300040D706D8D70640D70628D706D8D7062BE4
:10084000D706D8D70636D706D8D70640C106C0C1C6
:10085000062BC106C0C10620C10660C10640C10604
:1008600048D706D8D70656D70656D706D8D706395A
:10087000D706D8D70640FE06FFFE0680FE06FFFE1E
:100880000680FE06FFFE0680FE0680FE06FFFE06D0
:1008900080FE06FFFE06FFFE0680FE06FFFE0680C7
:1008A000FE06FFFE0102020640A106A0A10650A11D
:1008B00006A0A10636A106A0A10650A10640A106E9
:1008C000A0A10640A10630A10650A10640A10650F5
:1008D000A10648A106A0A10640C10660C1062BC121
:1008E0000660C10640C10648C106C0C10640C10637
:1008F00060C10640C10628C10660C1062BC106C002
:10090000C10636C10660C10640AB06ACAB062BABD8
:100910000656AB0620AB0656AB0640AB0648910622
:10092000909106569106569106909106399106903F
:10093000910640FE06FFFE0680FE06FFFE06FFFE55
:100940000680FE06FFFE06FFFE0680FE06FFFE0690
:10095000FFFE0680FE06FFFE06FFFE0680FE06FF87
:10096000FE066CD706D8D706D8D7066CD706D8D7D8
:1009700006D8D7066CD706D8D70678D706D8D706B4
:1009800072D7066CD706D8D706D8D706D8D706D8D8
:10099000D7066CD706D8D706D8D7066CD706D8D7CF
:1009A00006D8D7066CD706D8D70648D706D8D706B4
:1009B00050D706D8D7065AD70656D7066CD7066C36
:1009C000D70103040636D706D8D7066CD706D8D782
:1009D0000636D7066CD706D8D70636D706D8D70638
:1009E0003CD7066CD70639D70636D7066CD706D85B
:1009F000D7066CD706D8D70636D706D8D7066CD711
:100A00000636D7066CD706D8D70636D706D8D70607
:100A100024D7066CD70628D706D8D7062DD7062B9D
:100A2000D70636D70636F106F0F10678F106F0F172
:100A30000636F10678F106F0F10636F10678F10691
:100A40003CF106F0F10639F10636F106F0F106F058
:100A5000F10678F106F0F10636F106F0F10678F1CC
:100A60000636F106F0F10678F10636F106F0F106E9
:100A700024F106F0F10628F106F0F1062DF1062B1F
:100A8000F10636F10636F10650A106A0A10650A1E6
:100A90000636A106A0A10650A10636A106A0A10611
:100AA0003CA10650A10639A10636A10650A106A018
:100AB000A106A0A10650A10636A10650A106A0A13C
:100AC0000636A106A0A10650A10636A106A0A106E1
:100AD00024A106A0A10628A10650A1062DA1062B3F
:100AE000A10636A10103030636D706D8D7066CD770
:100AF00006D8D70636D7066CD706D8D70636D70617
:100B0000D8D7063CD7066CD70639D70636D7066C39
:100B1000D706D8D7066CD706D8D70636D706D8D783
:100B2000066CD70636D7066CD706D8D70636D70652
:100B3000D8D70624D7066CD70628D706D8D7062DCF
:100B4000D7062BD70636D70103020636D706D8D7E5
:100B5000066CD706D8D70636D7066CD706D8D70680
:100B600036D706D8D7063CD7066CD70639D706360F
:100B7000D7066CD706D8D7066CD706D8D70636D78F
:100B800006D8D7066CD70636D7066CD706D8D70650
:100B900036D706D8D70624D7066CD70628D706D866
:100BA000D7062DD7062BD70636D70636F106F0F135
:100BB0000678F106F0F10636F106F0F10678F10656
:100BC00036F10678F1063CF106F0F10639F1063609
:100BD000F106F0F10678F106F0F10678F10636F14B
:100BE00006F0F10678F10636F106F0F10678F10626
:100BF00036F106F0F10624F106F0F10628F106F0D0
:100C0000F1062DF1062BF10636F10636F10650A15C
:100C100006A0A10650A10636A106A0A10650A10675
:100C200036A106A0A1063CA10650A10639A10636B0
:100C3000A10650A106A0A106A0A10650A10636A1BA
:100C40000650A106A0A10636A106A0A10650A10645
:100C500036A106A0A1063CA106A0A10636A1062D3C
:100C6000A10650A10636A1062DA106A0A1010304EC
:100C70000636D70636D70636D7066CD7062DD706E2
:100C80006CD70636D70636D7066CD70636D7062871
:100C9000D7066CD70636D7066CD7063CD706D8D70A
:100CA0000636F10678F10624F10678F10636F106EB
:100CB0003CF106F0F10636F10678F10636F106222F
:100CC000F106F0F10624F10678F1062DF10678F12F
:100CD0000636A10650A10624A106A0A1061BA10666
:100CE00050A10636A1063CB506B4B50648B506487F
:100CF000B506B4B50630B5065AB50636D706D8D708
:100D0000066CD706D8D706D8D7066CD706D8D7062C
:100D1000D8D7066CD706D8D70636D7066CD7062D97
:100D2000D706D8D70636D706D8D70103040636D754
:100D300006D8D7066CD706D8D7062DD7066CD706A7
:100D4000D8D70636D7066CD70636D70628D7066C0E
:100D5000D70636D7066CD7063CD706D8D70636F165
:100D60000678F10624F10678F10636F1063CF10624
:100D7000F0F10636F10678F10636F10622F106F0BA
:100D8000F10624F10678F1062DF10678F10636A178
:100D90000650A10624A106A0A1061BA10650A1068B
:100DA00036A1063CB506B4B50648B50648B506B446
:100DB000B50630B5065AB50636D706D8D7066CD76D
:100DC00006D8D706D8D7066CD706D8D706D8D70600
:100DD0006CD706D8D70636D7066CD7062DD706D8D7
:100DE000D70636D706D8D70636A10650A106A0A149
:100DF00006A0A10650A106A0A106A0A10650A1062A
:100E000000000600000600000600000600000600C4
:100E10000006000006A0A10650A106A0A106A0A100
:100E20000650A106A0A106A0A10650A1060000063A
:100E30000000060000060000060000060000060094
:100E40000006B4B5065AB506B4B506B4B5065AB52B
:100E500006B4B506B4B5065AB506B4B506B4B506BB
:100E60005AB506B4B5065AB506B4B5065AB506B4B1
:100E7000B506D8D7066CD706D8D706D8D7066CD70C
:100E800006D8D706D8D7066CD706D8D706D8D7063F
:100E900036D706D8D7062DD7066CD70636D706D84C
:100EA000D70636D706D8D7066CD706D8D706D8D7F0
:100EB000066CD706D8D706D8D7066CD706D8D7067B
:100EC00036D7066CD7062DD706D8D70628D7066C96
:100ED000D70103040636A10650A106A0A106A0A1D1
:100EE0000650A106A0A106A0A10650A106A0A10639
:100EF000A0A10650A106A0A1065AA106A0A10650D5
:100F0000A106A0A106B4B5065AB506B4B506B4B597
:100F1000065AB506B4B506B4B5065AB506B4B50654
:100F2000B4B5065AB506B4B50660B506B4B5065AEA
:100F3000B506B4B506D8D7066CD706D8D706D8D725
:100F4000066CD706D8D706D8D7066CD706D8D706EA
:100F5000D8D70636D706D8D7062DD7066CD706368B
:100F6000D706D8D70636D706D8D7066CD706D8D72F
:100F700006D8D7066CD706D8D706D8D7066CD706BA
:100F8000D8D70636D7066CD7062DD706D8D706365B
:100F9000D7066CD70102020636D70600000600000D
:100FA000060000062DD70600000600000636D7060C
:100FB00000000636D70628D70600000636D70600FA
:100FC00000063CD70600000636B506000006000005
:100FD0000600000624B50600000600000636B50629
:100FE00000000636B50622B50600000624B5060048
:100FF00000062DB50600000636A10600000624A155
:10100000060000061BA10600000636A1063CA1064C
:1010100000A10648A10648A106A0A1062DA106A090
:10102000A10636D706D8D7066CD706D8D706D8D7A4
:10103000066CD706D8D706D8D7066CD706D8D706F9
:1010400036D7066CD7062DD706D8D70636D706D89A
:10105000D70636D706D8D7066CD706D8D7062DD7E9
:10106000066CD706D8D70636D7066CD70636D7060D
:1010700028D7066CD70636D7066CD7063CD706D8D5
:10108000D70636F10678F10624F10678F10636F136
:10109000063CF106F0F10636F10678F10636F10667
:1010A00022F106F0F10624F10678F1062DF106781A
:1010B000F10636A10650A10624A106A0A1061BA197
:1010C0000650A10636A1063CB506B4B50648B506DD
:1010D00048B506B4B50630B5065AB50636D706D8B3
:1010E000D7066CD706D8D706D8D7066CD706D8D778
:1010F00006D8D7066CD706D8D70636D7066CD706DB
:101100002DD706D8D70636D706D8D701030306361B
:10111000A10650A106A0A106A0A10650A106A0A16B
:1011200006A0A10650A106A0A106A0A10650A106F6
:10113000A0A1065AA106A0A10650A106A0A106B42E
:10114000B5065AB506B4B506B4B5065AB506B4B573
:1011500006B4B5065AB506B4B506B4B5065AB50612
:10116000B4B50660B506B4B5065AB506B4B506D82A
:10117000D7066CD706D8D706D8D7066CD706D8D7E7
:1011800006D8D7066CD706D8D706D8D70636D706DE
:10119000D8D7062DD7066CD70636D706D8D7063649
:1011A000D706D8D7066CD706D8D706D8D7066CD7B7
:1011B00006D8D706D8D7066CD706D8D70636D706AE
:1011C0006CD7062DD70636D7066CD706D8D70102BE
:1011D0000140D8D700FFFF00000000000000000021
:00000001FF
`
