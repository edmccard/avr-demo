package main

import (
	"bufio"
	"fmt"
	"os"
	"strings"
	"time"

	"github.com/edmccard/avr-sim/atmega8"
	"github.com/edmccard/avr-sim/dev"
)

func main() {
	sys := atmega8.NewSystem()
	sys.LoadProgHex(strings.NewReader(program))

	read := make(chan byte, 1)
	write := make(chan byte, 20)
	usart := dev.NewUSART(read, write, sys.Timer)

	sys.Memory.SetRW(0x2a, usart.ReadUCSRB, usart.WriteUCSRB)
	sys.Memory.SetRW(0x2b, usart.ReadUCSRA, usart.WriteUCSRA)
	sys.Memory.SetRW(0x2c, usart.ReadUDR, usart.WriteUDR)
	sys.Memory.SetRW(0x40, usart.ReadUCSRC, usart.WriteUCSRC)

	go func() {
		for {
			select {
			case c := <-write:
				fmt.Printf("%c", c)
			}
		}
	}()

	quit := sys.Go(1000000, 50, func() error { return nil })

	reader := bufio.NewReader(os.Stdin)
	text, _, _ := reader.ReadLine()
	for i, b := range text {
		read <- b
		// Hack to get around the fact that read will block after the
		// emulated program reads 18 bytes (17 here and the newline at
		// the end).
		if i == 16 {
			break
		}
	}
	// Send a newline
	read <- 10

	// Give the program long enough to print the reply
	time.Sleep(1 * time.Second)
	close(quit)
}

const program = `
:1000000012C02CC02BC02AC029C028C027C026C0BF
:1000100025C024C023C022C021C020C01FC01EC0D4
:100020001DC01CC01BC011241FBECFE5D4E0DEBF25
:10003000CDBF10E0A0E6B0E0EEEBF7E002C0059027
:100040000D92A239B107D9F720E0A2E9B0E001C0D2
:100050001D92A839B207E1F702D0AFC3D1CFCF9339
:10006000DF93CDB7DEB764970FB6F894DEBF0FBE4F
:10007000CDBF35D002E910E080E690E0F801918331
:10008000808390939500809394009C0141E150E01F
:1000900061E070E08EE690E080D0F801408151810F
:1000A00063E170E0CE01019641D0892B09F416C0BE
:1000B000CE0101969F938F9380E890E09F938F935A
:1000C000E4E9F0E081818F9380818F9357D00F9086
:1000D0000F900F900F900F900F90E9CFFFCF82E01D
:1000E0008BB98CE089B988E18AB90895CF93C82F7C
:1000F000873061F4209196003091970047E050E0FE
:1001000061E070E08AE890E048D007C08A3011F4DE
:100110008DE0ECDF5D9BFECFCCB980E090E0CF912D
:1001200008955F9BFECF8CB190E00895A0E0B0E011
:10013000EBE9F0E015C36C017A01FA01838180FDDF
:1001400003C080E090E016C016161706D4F78B01A6
:10015000CC2DDD2D0130110559F0C70129D28F3F7B
:10016000EFEF9E0771F38993015011090A9791F7F8
:100170001882C601CDB7DEB7E8E00EC3A0E0B0E05C
:10018000E3ECF0E0F3C2AE01475F5F4F6F8178852B
:100190008D819E8134D0E2E005C3A0E0B0E0E2EDC5
:1001A000F0E0DAC26B014A017901D90113962C9172
:1001B00021FF1DC0C0E0D0E0C815D905D9F08C01E1
:1001C0005C01AC0CBD1CC8010A151B0571F00F5F6A
:1001D0001F4FD7011896ED91FC911997B701DC01DB
:1001E0008C910995892B79F305C02196E5CF80E0A4
:1001F00090E001C0CE01CDB7DEB7ECE0C9C2ACE003
:10020000B0E0E4E0F1E0A2C27C016B018A01FC01F4
:1002100017821682838181FFB0C1CE0101964C0105
:10022000F7019381F60193FD859193FF81916F0111
:10023000882309F49EC1853239F493FD859193FF9B
:1002400081916F01853221F4B70190E0EFD1E8CFC1
:10025000512C312C20E02032A0F48B3269F030F4A4
:10026000803259F0833269F420612CC08D3239F02C
:10027000803339F4216026C02260246023C02860C6
:1002800021C027FD27C030ED380F3A3078F426FF23
:1002900006C0FAE05F9E300D1124532E13C08AE091
:1002A000389E300D1124332E20620CC08E3221F482
:1002B00026FD5FC1206406C08C3611F4206802C0A0
:1002C000883641F4F60193FD859193FF81916F018A
:1002D0008111C1CF982F9F7D9554933028F40C5FE6
:1002E0001F4FFFE3F9830DC0833631F0833771F080
:1002F000833509F057C021C0F801808189830E5FE2
:100300001F4F44244394512C540114C03801F2E08F
:100310006F0E711CF801A080B18026FF03C0652D0F
:1003200070E002C06FEF7FEFC5012C8736D12C0142
:1003300083012C852F77222E16C03801F2E06F0E34
:10034000711CF801A080B18026FF03C0652D70E00C
:1003500002C06FEF7FEFC5012C8714D12C012C85D3
:100360002068222E830123FC19C0832D90E04816BB
:100370005906A0F4B70180E290E058D13A94F5CF45
:10038000F50127FC859127FE81915F01B70190E07F
:100390004DD131103A94F1E04F1A510841145104F3
:1003A00079F7DEC0843611F0893631F5F80127FF80
:1003B00007C060817181828193810C5F1F4F08C0EB
:1003C00060817181882777FD8095982F0E5F1F4F80
:1003D0002F76B22E97FF09C0909580957095619504
:1003E0007F4F8F4F9F4F2068B22E2AE030E0A4014C
:1003F0004FD1A82EA81843C0853729F42F7EB22EDE
:100400002AE030E025C0F22FF97FBF2E8F36C1F0F1
:1004100018F4883579F0ADC0803719F0883721F0AD
:10042000A8C02F2F2061B22EB4FE0DC08B2D84608A
:10043000B82E09C024FF0AC09F2F9660B92E06C0AF
:1004400028E030E005C020E130E002C020E132E0E9
:10045000F801B7FE07C060817181828193810C5FD2
:100460001F4F06C06081718180E090E00E5F1F4FDA
:10047000A4010ED1A82EA818FB2DFF77BF2EB6FE23
:100480000BC02B2D2E7FA51450F4B4FE0AC0B2FC75
:1004900008C02B2D2E7E05C07A2C2B2D03C07A2C64
:1004A00001C0752C24FF0DC0FE01EA0DF11D8081F5
:1004B000803311F4297E09C022FF06C0739473941F
:1004C00004C0822F867809F0739423FD12C020FFA8
:1004D00006C05A2C731418F4530C5718732C731449
:1004E00060F4B70180E290E02C87A0D073942C8553
:1004F000F6CF731410F4371801C0312C24FF11C04B
:10050000B70180E390E02C8791D02C8522FF16C0A4
:1005100021FF03C088E590E002C088E790E0B701C2
:100520000CC0822F867851F021FD02C080E201C00C
:100530008BE227FD8DE2B70190E078D0A51430F46E
:10054000B70180E390E072D05A94F8CFAA94F401F6
:10055000EA0DF11D8081B70190E068D0A110F6CFBF
:10056000332009F45DCEB70180E290E05FD03A9489
:10057000F7CFF7018681978102C08FEF9FEF2C960E
:10058000E2E100C1FC010590615070400110D8F714
:10059000809590958E0F9F1F0895FC0161507040CB
:1005A00001900110D8F7809590958E0F9F1F0895A8
:1005B000CF93DF93EC012B8120FF33C026FF0AC0CD
:1005C0002F7B2B838E819F8101969F838E838A81CF
:1005D00090E029C022FF0FC0E881F981808199272E
:1005E00087FD9095009719F420622B831AC03196ED
:1005F000F983E8830EC0EA85FB85099597FF09C05A
:100600002B81019611F480E101C080E2822B8B8363
:1006100008C02E813F812F5F3F4F3F832E83992754
:1006200002C08FEF9FEFDF91CF9108950F931F933B
:10063000CF93DF93182F092FEB018B8181FD03C02E
:100640008FEF9FEF20C082FF10C04E815F812C8111
:100650003D81421753077CF4E881F9819F012F5FA8
:100660003F4F39832883108306C0E885F985812FA1
:100670000995892B29F72E813F812F5F3F4F3F83BB
:100680002E83812F902FDF91CF911F910F9108958D
:10069000FA01AA27283051F1203181F1E8946F93B3
:1006A0006E7F6E5F7F4F8F4F9F4FAF4FB1E03ED059
:1006B000B4E03CD0670F781F891F9A1FA11D680FF7
:1006C000791F8A1F911DA11D6A0F711D811D911D2A
:1006D000A11D20D009F468943F912AE0269F11249F
:1006E0003019305D3193DEF6CF010895462F477003
:1006F000405D4193B3E00FD0C9F7F6CF462F4F705E
:10070000405D4A3318F0495D31FD4052419302D0BB
:10071000A9F7EACFB4E0A695979587957795679561
:10072000BA95C9F700976105710508959B01AC0161
:100730000A2E06945795479537952795BA95C9F788
:10074000620F731F841F951FA01D08952F923F9263
:100750004F925F926F927F928F929F92AF92BF92D1
:10076000CF92DF92EF92FF920F931F93CF93DF937D
:10077000CDB7DEB7CA1BDB0B0FB6F894DEBF0FBEDA
:10078000CDBF09942A88398848885F846E847D8427
:100790008C849B84AA84B984C884DF80EE80FD8029
:1007A0000C811B81AA81B981CE0FD11D0FB6F8949F
:0E07B000DEBF0FBECDBFED010895F894FFCF60
:1007BE000000000300000000760091000000456E6E
:1007CE0074657220796F7572206E616D653A2000C6
:1007DE0048656C6C6F2C202573002A72696E672A2F
:0207EE000A00FF
:00000001FF
`
